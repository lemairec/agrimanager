<?php

namespace AgriBundle\Repository;
use AgriBundle\Entity\Produit;

/**
 * ProduitRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProduitRepository extends \Doctrine\ORM\EntityRepository
{
    function findOrCreate($completeName, $campagne){
        $em = $this->getEntityManager();
        $produit = $this->findOneByCompleteName($completeName);
        if($produit){
            return $produit;
        }
        $produit = new Produit();
        $produit->campagne = $campagne;
        $produit->name = $completeName;
        $produit->completeName = $completeName;
        $ephy = $em->getRepository('AgriBundle:EphyProduit')->findOneByCompleteName($completeName);
        if($ephy){
            $produit->type = "ppp";
        } else {
            $produit->type = "autre";
        }
        $produit->ephyProduit = $ephy;
        $em->persist($produit);
        $em->flush();
        return $produit;
    }

    function findOrCreateCaj($name, $type, $unity,   $campagne){
        $em = $this->getEntityManager();
        $completeName = $name.' - '.$unity;
        $produit = $this->findOneByCompleteName($completeName);
        print $completeName;
        if($produit){
            return $produit;
        }
        $produit = new Produit();
        $produit->campagne = $campagne;
        $produit->name = $completeName;
        $produit->completeName = $completeName;
        $produit->type = $type;
        $produit->unity = $unity;
        $ephy = $em->getRepository('AgriBundle:EphyProduit')->findOneByCompleteName($completeName);
        if($ephy){
            $produit->type = "ppp";
        } else {
            $produit->type = "autre";
        }
        $produit->ephyProduit = $ephy;
        $em->persist($produit);
        $em->flush();
        return $produit;
    }

    function update($produit){
        $em = $this->getEntityManager();
        $qty = $em->getRepository('AgriBundle:Achat')->createQueryBuilder('a')
            ->select('SUM(a.qty)')
            ->where('a.produit = :produit')
            ->setParameter('produit', $produit)
            ->getQuery()
            ->getSingleScalarResult();
        $qty2 = $em->getRepository('AgriBundle:InterventionProduit')->createQueryBuilder('a')
            ->select('SUM(a.qty)')
            ->where('a.produit = :produit')
            ->setParameter('produit', $produit)
            ->getQuery()
            ->getSingleScalarResult();
        $price = $em->getRepository('AgriBundle:Achat')->createQueryBuilder('a')
            ->select('MAX(a.price)')
            ->where('a.produit = :produit')
            ->setParameter('produit', $produit)
            ->getQuery()
            ->getSingleScalarResult();
        $produit->qty = $qty - $qty2;
        if($price > 0){
            $produit->price = $price;
        }
        $em->persist($produit);
        $em->flush();
    }

    function save($produit){
        $produit_count = $this->createQueryBuilder('p')
            ->select('COUNT(p)')
            ->where('p.name = :name and p.amm = :amm')
            ->setParameter('name', $produit->name)
            ->setParameter('amm', $produit->amm)
            ->getQuery()
            ->getSingleScalarResult();
        echo("produit_count ".$produit_count."\n");
        if($produit_count == 0){
            $produit->completeName = $produit->amm . ' - ' . $produit->name;
            $em = $this->getEntityManager();
            $em->persist($produit);
            $em->flush();
        }
        return $produit;
    }

    function getAllName($campagne){
        $em = $this->getEntityManager();
        $res = [];
        $produits = $this->findByCampagne($campagne);
        foreach($produits as $p){
            $res[] = $p->completeName;
        }
        $produits = $em->getRepository('AgriBundle:EphyProduit')->findAll();
        foreach($produits as $p){
            $res[] = $p->completeName;
        }

        return  array_unique($res);
    }

    function delete($produit_id){
        $em = $this->getEntityManager();
        $produit = $this->findOneById($produit_id);
        $em->remove($produit);
        $em->flush();
    }
}
