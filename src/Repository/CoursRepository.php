<?php

namespace App\Repository;

use Datetime;
use App\Entity\Gestion\Cours;
use App\Entity\Campagne;

/**
 * CoursRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CoursRepository extends \Doctrine\ORM\EntityRepository
{
    function saveArray($company, $array){
        $date = Datetime::createFromFormat("d/m/Y", $array["date"]);
        foreach($array as $key => $value){
            if($key != "date"){
                $this->save($company, $date, $key, $value);
            }
        }

    }

    function setArray($company, $array){
        foreach($array as $key => $value){
            $cours = $this->getLast($company, $array[$key]["name"]);
            if($cours){
                $array[$key]["value"]=$cours->value;
            }
        }
        return $array;
    }

    function getLast($company, $produit){
        $values = explode("_", $produit);
        $em = $this->getEntityManager();
        return $this->createQueryBuilder('p')
            ->where('p.campagne = :campagne')
            ->andWhere('p.produit = :produit')
            ->orderBy('p.date', 'DESC')
            ->setParameter('produit', $produit)
            ->setMaxResults(1)
            ->getQuery()->getFirstResult();
    }

    function save($company, $date, $produit, $value){
        $em = $this->getEntityManager();

        $cours = new Cours();
        $cours->date = $date;
        $cours->value = $value;
        $cours->produit = $produit;


        $em->persist($cours);
        $em->flush();
    }

    function getAllForCampagne($campagne){
            return $this->createQueryBuilder('p')
            ->where('p.campagne = :campagne')
            ->orderBy('p.date', 'DESC')
            ->addOrderBy('p.produit', 'ASC')
            ->setParameter('campagne', $campagne)
            ->getQuery()->getResult();
    }
}
