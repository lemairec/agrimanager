{% extends 'base_agri.html.twig' %}

{% block body %}
    <div class="card">
        

        <div class="card-body">


    </div>

    <div class="card">
        <div id="map" style="position: relative;height: 600px;"></div>
        <div class="card-header">
            <button id="add_Tuyaux" type="button" class="btn btn-primary" onclick="addTuyaux()">Add Tuyaux</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Tuyaux
        </div>
        <div class="list-group">
            {% for tuyau in tuyaux %}
            <div class="list-group-item flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-6">
                        <a href="{{ url("irri_tuyaux", {'tuyaux_id': tuyau.id}) }}">{{tuyau.name}}
                        </a>
                    </h5>
                    <div class="mb-3">
                        {{ tuyau.params}}
                    </div>
                    <div class="mb-3">
                        {{ tuyau.longueur | showUnity('m')}}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Bornes
            <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url("irri_reset", {'projet_id': projet.id}) }}'">Reset</button>
            <button type="button" class="btn btn-primary" onclick="window.location.href='{{ url("irri_calcul", {'projet_id': projet.id}) }}'">Calcul</button>
        </div>
        <div class="list-group">
            {% for borne in bornes %}
            <div class="list-group-item flex-column align-items-start">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">
                        <a href="{{ url("irri_borne", {'borne_id': borne.id}) }}">{{borne.name}}
                        </a>
                    </h5>
                    <div class="mb-3">
                        {{ borne.pression  | showUnity('bar')}}
                    </div>
                    <div class="mb-3">
                        {{ borne.calculate_pression  | showUnity('bar')}}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    

{% endblock %}


{% block javascripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.css">

<!-- On charge le code JavaScript de la librairie leaflet -->
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
<script src="/js/leaflet-measure.js"></script>
<script src="http://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.js"></script>

<script>
    console.log("otot");
    var latlngs_job = [];
    function addBorne () {
        console.log("addBorne");
        console.log(latlngs_job);
        console.log(JSON.stringify(latlngs_job));

        window.location = "/irrigation/borne/0?points="+JSON.stringify(latlngs_job)
    }

    function addTuyaux () {
        console.log("addTuyaux");
        console.log(latlngs_job);
        console.log(JSON.stringify(latlngs_job));

        window.location = "/irrigation/tuyaux/0?projet_id={{projet.id}}&points="+JSON.stringify(latlngs_job)
    }

    var redIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var goldIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    window.addEventListener( "load", function( event ) {
        var map = L.map( 'map');

        var measureControl = L.control.measure({ primaryLengthUnit: 'meters', secondaryLengthUnit: 'kilometers', primaryAreaUnit: 'hectares' });
        measureControl.addTo(map);

        map.setView( [{{lat}},  {{lon}} /*longitude*/], 18 /*zoom*/ );

        // --- We add a layer based on OpenStreetMap ---
        L.tileLayer( 'http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.example.com/">Example</a>',
            maxNativeZoom:19,
            maxZoom:35
        }).addTo(map);   // Base Map
        
        var polyline2 = new L.Polyline([]).addTo(map);
        map.on('click', function(event) {
            new L.Marker(event.latlng).addTo(map);
            polyline2.addLatLng(event.latlng);
            latlngs_job.push([event.latlng.lat, event.latlng.lng]);
            console.log(latlngs_job);

        });
        


        {% for borne in bornes %}
            var marker = new L.Marker([{{borne.lat}},{{borne.lon}}] , {icon: goldIcon}).addTo(map);
            marker.bindPopup("{{borne.name}}  {{borne.calculate_pression | showUnity('bar')}}");
        {% endfor %}


        {% for tuyau in tuyaux %}
            var latlngs = {{ tuyau.points |json_encode() }};
            var polyline = new L.Polyline(latlngs, {weight:5, color: 'red'}).addTo(map);

            var marker = new L.Marker([(latlngs[0][0]+latlngs[1][0])/2,(latlngs[0][1]+latlngs[1][1])/2] , {icon: redIcon}).addTo(map);
            marker.bindPopup("{{tuyau.name}} {{tuyau.params}} {{tuyau.longueur | showUnity('m')}}");
        {% endfor %}

        var layer = L.geoportalLayer.WMTS({
          layer: "ORTHOIMAGERY.ORTHOPHOTOS"
        });

        layer.addTo(map);
        

        var layerSwitcher = L.geoportalControl.LayerSwitcher();
        map.addControl(layerSwitcher);
    });
</script>

{% endblock %}
